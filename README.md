# 第3-5次实验报告 #

没说要写也没说不写，那就写写吧。第三次当时写完了就懒得看这个了，这次也顺手写一下。

## 第三次实验设计 ##

- 整体设计为用visitor对语法树进行一次遍历，遍历每个节点时都去更新语法树打印内容（先存储），然后进行相关检查，如果检查不通过，则直直接打印错误信息，否则打印语法树。

- 关于变量的存储，整体用了实验帮助文档的类型设计，另外添加了Other用以处理错误情况（检测到错误，但不对该错误输出的类型）。关于作用域，借用了当时在SICP写scm解释器时的设计，用了一种类似于链表的方式。

## 第三次实验问题 ##

- 定义域的问题。虽然借用了SICP当时的作用域的设计，但是没借用到位。最开始我以为变量不会在全局声明，于是仅把作用域切换放在FuncDef和Stmt。接着发现第二个问题，退出IF等block的时候作用域切换错误，调整了在stmt切换作用域的时机解决。

- 在这次实验中我才发现原来我遍历的做法似乎比较邪门。我没有去调用父类visitor的visitorChildren方法，而是自己写了个函数递归调用。因此，某些本不该访问的节点（如检测到函数声明有错误，则不对函数体继续访问）都被我访问了。于是设置了一些布尔值打了补丁。

## 第四次及第五次实验 ##

- 对于计算表达式的值，我使用自己实现的getExpType来计算。个人认为这也是一种可行的方案，当然相对的调用LLVM的api会少一些（？）。希望后续不会出现问题......

- 经过lab3的酷刑，这两次实验显得温和许多，同时也让我对自己的代码有了进一步的思考。我原本实现的Visitor对节点的遍历方法较奇怪。于是在新的LLVMVisitor中，我调用了原生的visitChildren去遍历，感觉确实简单不少。除此之外，之前设计的Frame类我认为也有改进的地方，只需要我把Frame中关于符号表的值用泛型替代，可以避免代码的重复。

